{% extends "base.html" %}

{% block title %}WiFi Access Point - PixelPi{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>üì∂ WiFi Access Point</h2>
    <p class="text-muted">Create a wireless network for iPad and device connectivity</p>

    <!-- Status Card -->
    <div class="card mb-4" id="statusCard">
        <div class="card-body">
            <h5 class="card-title">Status</h5>
            <div id="wifiStatus">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Card -->
    <div class="card mb-4" id="configCard">
        <div class="card-body">
            <h5 class="card-title">Configuration</h5>
            <form id="wifiConfigForm">
                <div class="mb-3">
                    <label for="ssid" class="form-label">Network Name (SSID)</label>
                    <input type="text" class="form-control" id="ssid" 
                           placeholder="WLED-Manager-AP" required maxlength="32">
                    <div class="form-text">The name users will see when connecting</div>
                </div>

                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" 
                           placeholder="Minimum 8 characters" required minlength="8">
                    <div class="form-text">WPA2 password (minimum 8 characters)</div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="channel" class="form-label">WiFi Channel</label>
                        <select class="form-select" id="channel">
                            <option value="1">1 (2.412 GHz)</option>
                            <option value="6" selected>6 (2.437 GHz)</option>
                            <option value="11">11 (2.462 GHz)</option>
                        </select>
                        <div class="form-text">Recommended: 1, 6, or 11</div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="ipAddress" class="form-label">IP Address</label>
                        <input type="text" class="form-control" id="ipAddress" 
                               value="10.0.2.1" required pattern="^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$">
                        <div class="form-text">Gateway IP for WiFi network</div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" id="configureBtn">
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                    Configure WiFi AP
                </button>
            </form>
        </div>
    </div>

    <!-- Connected Clients Card -->
    <div class="card" id="clientsCard" style="display: none;">
        <div class="card-body">
            <h5 class="card-title">Connected Devices</h5>
            <div id="clientsList">
                <p class="text-muted">No devices connected</p>
            </div>
        </div>
    </div>

    <!-- Alert Area -->
    <div id="alertArea"></div>
</div>

<!-- Control Buttons Modal would go here if needed -->

<script>
let wifiStatus = null;

// Load WiFi status on page load
document.addEventListener('DOMContentLoaded', function() {
    loadWiFiStatus();
    // Refresh status every 10 seconds
    setInterval(loadWiFiStatus, 10000);
});

function loadWiFiStatus() {
    fetch('/api/wifi/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                wifiStatus = data.status;
                updateStatusDisplay();
            } else {
                showAlert('danger', 'Error loading WiFi status: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'Failed to load WiFi status');
        });
}

function updateStatusDisplay() {
    const statusDiv = document.getElementById('wifiStatus');
    
    if (!wifiStatus.installed) {
        statusDiv.innerHTML = `
            <div class="alert alert-warning">
                <strong>WiFi AP Not Installed</strong>
                <p class="mb-0">WiFi Access Point feature is not installed. Run the installation script to enable this feature.</p>
            </div>
        `;
        document.getElementById('configCard').style.display = 'none';
        return;
    }

    const isActive = wifiStatus.active;
    const config = wifiStatus.config;
    
    let statusHtml = `
        <div class="row align-items-center">
            <div class="col-md-6">
                <p class="mb-1"><strong>Status:</strong> 
                    <span class="badge ${isActive ? 'bg-success' : 'bg-secondary'}">
                        ${isActive ? '‚óè Active' : '‚óã Inactive'}
                    </span>
                </p>
                ${config ? `
                    <p class="mb-1"><strong>Network:</strong> ${config.ssid}</p>
                    <p class="mb-1"><strong>IP Address:</strong> ${config.ip_address}</p>
                    <p class="mb-0"><strong>Channel:</strong> ${config.channel}</p>
                ` : ''}
            </div>
            <div class="col-md-6 text-end">
                ${isActive ? `
                    <button class="btn btn-warning me-2" onclick="disableWiFi()">Disable</button>
                    <button class="btn btn-secondary" onclick="restartWiFi()">Restart</button>
                ` : `
                    <button class="btn btn-success" onclick="enableWiFi()">Enable</button>
                `}
            </div>
        </div>
    `;
    
    statusDiv.innerHTML = statusHtml;

    // Update form with current config
    if (config) {
        document.getElementById('ssid').value = config.ssid;
        document.getElementById('channel').value = config.channel;
        document.getElementById('ipAddress').value = config.ip_address;
    }

    // Show connected clients if active
    if (isActive && wifiStatus.clients && wifiStatus.clients.length > 0) {
        updateClientsList(wifiStatus.clients);
        document.getElementById('clientsCard').style.display = 'block';
    } else {
        document.getElementById('clientsCard').style.display = 'none';
    }
}

function updateClientsList(clients) {
    const clientsDiv = document.getElementById('clientsList');
    
    if (clients.length === 0) {
        clientsDiv.innerHTML = '<p class="text-muted">No devices connected</p>';
        return;
    }

    let html = `
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>IP Address</th>
                        <th>MAC Address</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;

    clients.forEach(client => {
        html += `
            <tr>
                <td>${client.ip}</td>
                <td><code>${client.mac}</code></td>
                <td><span class="badge ${client.state === 'REACHABLE' ? 'bg-success' : 'bg-secondary'}">${client.state}</span></td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    clientsDiv.innerHTML = html;
}

// Configure WiFi AP
document.getElementById('wifiConfigForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const ssid = document.getElementById('ssid').value;
    const password = document.getElementById('password').value;
    const channel = parseInt(document.getElementById('channel').value);
    const ipAddress = document.getElementById('ipAddress').value;
    
    const btn = document.getElementById('configureBtn');
    const spinner = btn.querySelector('.spinner-border');
    
    btn.disabled = true;
    spinner.classList.remove('d-none');
    
    fetch('/api/wifi/configure', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ssid, password, channel, ip_address: ipAddress})
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        spinner.classList.add('d-none');
        
        if (data.success) {
            showAlert('success', 'WiFi AP configured successfully! Click Enable to start the access point.');
            loadWiFiStatus();
        } else {
            showAlert('danger', 'Configuration failed: ' + data.error);
        }
    })
    .catch(error => {
        btn.disabled = false;
        spinner.classList.add('d-none');
        showAlert('danger', 'Error: ' + error.message);
    });
});

function enableWiFi() {
    if (!confirm('Enable WiFi Access Point? This will start broadcasting the wireless network.')) {
        return;
    }
    
    fetch('/api/wifi/enable', {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                setTimeout(loadWiFiStatus, 2000);
            } else {
                showAlert('danger', 'Failed to enable: ' + data.error);
            }
        })
        .catch(error => showAlert('danger', 'Error: ' + error.message));
}

function disableWiFi() {
    if (!confirm('Disable WiFi Access Point? This will stop the wireless network.')) {
        return;
    }
    
    fetch('/api/wifi/disable', {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('info', data.message);
                setTimeout(loadWiFiStatus, 2000);
            } else {
                showAlert('danger', 'Failed to disable: ' + data.error);
            }
        })
        .catch(error => showAlert('danger', 'Error: ' + error.message));
}

function restartWiFi() {
    fetch('/api/wifi/restart', {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                setTimeout(loadWiFiStatus, 3000);
            } else {
                showAlert('danger', 'Failed to restart: ' + data.error);
            }
        })
        .catch(error => showAlert('danger', 'Error: ' + error.message));
}

function showAlert(type, message) {
    const alertArea = document.getElementById('alertArea');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show mt-3`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertArea.appendChild(alert);
    
    setTimeout(() => alert.remove(), 5000);
}
</script>
{% endblock %}
