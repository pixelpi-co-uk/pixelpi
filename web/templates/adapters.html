{% extends "base.html" %}

{% block title %}Network Adapters - PixelPi{% endblock %}
{% block nav_adapters %}active{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-ethernet"></i> Network Adapters
        </h1>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <button class="btn btn-primary" onclick="loadAdapters()">
            <i class="bi bi-arrow-clockwise"></i> Refresh Adapters
        </button>
    </div>
</div>

<!-- USB Ethernet Adapters -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-usb-symbol"></i> USB Ethernet Adapters
                </h5>
            </div>
            <div class="card-body">
                <div id="usb-adapters-container">
                    <div class="text-center text-muted py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading adapters...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Modal -->
<div class="modal fade" id="configureModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configure Adapter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="configureForm">
                    <input type="hidden" id="config-interface" name="interface">
                    
                    <div class="mb-3">
                        <label for="config-ip" class="form-label">IP Address</label>
                        <input type="text" class="form-control" id="config-ip" 
                               placeholder="10.0.0.1" required>
                        <div class="form-text">Enter the static IP address for this adapter</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="config-subnet" class="form-label">Subnet Mask (CIDR)</label>
                        <select class="form-select" id="config-subnet">
                            <option value="24" selected>/24 (255.255.255.0)</option>
                            <option value="16">/16 (255.255.0.0)</option>
                            <option value="8">/8 (255.0.0.0)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveConfiguration()">
                    <i class="bi bi-save"></i> Apply Configuration
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
let configModal;

document.addEventListener('DOMContentLoaded', function() {
    configModal = new bootstrap.Modal(document.getElementById('configureModal'));
    loadAdapters();
});

function loadAdapters() {
    fetch('/api/adapters/usb')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAdapters(data.adapters);
            } else {
                showAlert('Error loading adapters: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Failed to load adapters', 'danger');
        });
}

function displayAdapters(adapters) {
    const container = document.getElementById('usb-adapters-container');
    
    if (adapters.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No USB Ethernet adapters detected. 
                Please plug in a USB-to-Ethernet adapter and refresh.
            </div>
        `;
        return;
    }
    
    let html = '<div class="row g-3">';
    
    adapters.forEach(adapter => {
        const statusClass = adapter.connected ? 'success' : 'secondary';
        const statusIcon = adapter.connected ? 'check-circle-fill' : 'x-circle-fill';
        const statusText = adapter.connected ? 'Connected' : 'No Carrier';
        
        html += `
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>${adapter.interface}</strong>
                        <span class="badge bg-${statusClass}">
                            <i class="bi bi-${statusIcon}"></i> ${statusText}
                        </span>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm mb-2">
                            <tr>
                                <td width="40%"><strong>MAC Address:</strong></td>
                                <td><code>${adapter.mac_address || 'N/A'}</code></td>
                            </tr>
                            <tr>
                                <td><strong>IP Address:</strong></td>
                                <td><code>${adapter.ip_address || 'Not configured'}</code></td>
                            </tr>
                            <tr>
                                <td><strong>Subnet:</strong></td>
                                <td><code>${adapter.subnet_mask ? '/' + adapter.subnet_mask : 'N/A'}</code></td>
                            </tr>
                            ${adapter.driver ? `
                            <tr>
                                <td><strong>Driver:</strong></td>
                                <td><code>${adapter.driver}</code></td>
                            </tr>
                            ` : ''}
                        </table>
                        <button class="btn btn-sm btn-primary" 
                                onclick="showConfigureModal('${adapter.interface}', '${adapter.ip_address || ''}')">
                            <i class="bi bi-gear"></i> Configure
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function showConfigureModal(interface, currentIp) {
    document.getElementById('config-interface').value = interface;
    document.getElementById('config-ip').value = currentIp;
    configModal.show();
}

function saveConfiguration() {
    const interface = document.getElementById('config-interface').value;
    const ipAddress = document.getElementById('config-ip').value;
    const subnetMask = document.getElementById('config-subnet').value;
    
    // Validate IP
    if (!isValidIP(ipAddress)) {
        showAlert('Please enter a valid IP address', 'danger');
        return;
    }
    
    fetch(`/api/adapters/${interface}/configure`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            ip_address: ipAddress,
            subnet_mask: subnetMask
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`Adapter ${interface} configured successfully`, 'success');
            configModal.hide();
            setTimeout(loadAdapters, 2000);
        } else {
            showAlert('Configuration failed: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to configure adapter', 'danger');
    });
}

function isValidIP(ip) {
    const pattern = /^(\d{1,3}\.){3}\d{1,3}$/;
    if (!pattern.test(ip)) return false;
    
    const octets = ip.split('.');
    for (let octet of octets) {
        if (parseInt(octet) > 255) return false;
    }
    return true;
}
</script>
{% endblock %}
